name: Node Application

on:
  workflow_call:
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: true
        type: string

      server_ip:
        description: 'Public IP address of the deployment server'
        required: true
        type: string

      server_user:
        description: 'SSH user for the remote server (e.g., ubuntu)'
        required: true
        type: string

      app:
        description: 'Absolute path to the app directory on the server'
        required: true
        type: string

      script:
        description: 'Optional post-deployment shell commands'
        required: false
        type: string
        default: ''

    secrets:
      ssh_key:
        description: 'Private SSH key with access to the server'
        required: true

jobs:
  deploy:
    name: Deploy Node.js App
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Set up SSH
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ inputs.server_ip }} >> ~/.ssh/known_hosts
        env:
          SSH_KEY: ${{ secrets.ssh_key }}

      - name: ğŸš€ Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ inputs.server_user }}@${{ inputs.server_ip }} '
            set -e
      
            echo "ğŸ“ Changing into app directory..."
            cd ${{ inputs.app }}
      
            echo "ğŸ§¹ Cleaning uncommitted changes, keeping .env..."
            git reset --hard HEAD
            git clean -fd -e .env
      
            echo "â¬‡ï¸ Pulling latest from branch: ${{ inputs.branch }}"
            git pull origin ${{ inputs.branch }}
      
            echo "ğŸ“¦ Installing dependencies..."
            yarn install --frozen-lockfile
      
            echo "ğŸ”¨ Building app..."
            yarn build
      
            echo "ğŸš€ Running deploy script if provided..."
            if [ ! -z "${{ inputs.script }}" ]; then
              bash -c "${{ inputs.script }}"
            fi
          '
